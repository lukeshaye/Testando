[
  {
    "file": "/packages/api/src/core/auth.ts",
    "content": "/*\n * Arquivo: /packages/api/src/core/auth.ts\n * O Quê (Lógica): Criar um authMiddleware genérico que depende da Interface.\n * DIP (2.9): O middleware depende de c.var.authAdapter, não do Supabase.\n */\n\nimport { createMiddleware } from 'hono/factory';\nimport type { Variables } from '../types';\n\n/**\n * Middleware de autenticação.\n * Verifica o token 'Authorization' e usa o IAuthAdapter injetado (c.var.authAdapter)\n * para validar o usuário.\n * Se for válido, injeta o usuário em c.set('user').\n */\nexport const authMiddleware = createMiddleware<{ Variables: Variables }>( // \n  async (c, next) => {\n    // 1. Extrair o token do header\n    const token = c.req.header('Authorization')?.replace('Bearer ', '');\n\n    // 2. Validar se o token existe\n    if (!token) {\n      return c.json({ error: 'Unauthorized', message: 'No token provided' }, 401);\n    }\n\n    try {\n      // 3. Validar o token usando o adaptador (DIP)\n      const user = await c.var.authAdapter.validateToken(token);\n\n      // 4. Validar se o usuário foi retornado\n      if (!user) {\n        return c.json({ error: 'Unauthorized', message: 'Invalid token' }, 401);\n      }\n\n      // 5. Injetar o usuário no contexto para uso nos handlers\n      c.set('user', user);\n\n      // 6. Continuar para o próximo middleware ou rota\n      await next();\n    } catch (err) {\n      console.error('AuthMiddleware Error:', err);\n      return c.json({ error: 'Unauthorized', message: 'Token validation failed' }, 401);\n    }\n  }\n); // \n"
  }
]