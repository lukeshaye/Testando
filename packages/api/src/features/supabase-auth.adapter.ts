[
  {
    "file": "/packages/api/src/adapters/supabase-auth.adapter.ts",
    "content": "/*\n * Arquivo: /packages/api/src/adapters/supabase-auth.adapter.ts (Novo)\n * O Quê (Lógica): Criar a Implementação Supabase da IAuthAdapter.\n * Pilar 18: Esta é a implementação concreta.\n */\n\nimport {\n  SupabaseClient, \n  SignInWithPasswordCredentials, \n  SignUpWithPasswordCredentials \n} from '@supabase/supabase-js'; // \nimport { IAuthAdapter, AuthUser } from '../core/auth.adapter'; // \n\nexport class SupabaseAuthAdapter implements IAuthAdapter { // \n  constructor(private client: SupabaseClient) {} // \n\n  /**\n   * Valida um token de autenticação (JWT).\n   */\n  async validateToken(token: string): Promise<AuthUser | null> {\n    const { data, error } = await this.client.auth.getUser(token);\n\n    if (error || !data.user) {\n      return null;\n    }\n\n    // Adapta o usuário do Supabase para o AuthUser genérico\n    const { id, email } = data.user;\n    if (!email) {\n      // O contrato AuthUser exige um email\n      return null;\n    }\n\n    return { id, email };\n  }\n\n  /**\n   * Realiza o login (Sign In) com credenciais.\n   */\n  async signIn(\n    credentials: SignInWithPasswordCredentials\n  ): Promise<{ user: AuthUser; token: string } | null> {\n    const { data, error } = await this.client.auth.signInWithPassword(credentials);\n\n    if (error || !data.user || !data.session) {\n      return null;\n    }\n\n    const { id, email } = data.user;\n    if (!email) {\n      return null;\n    }\n\n    return {\n      user: { id, email },\n      token: data.session.access_token,\n    };\n  }\n\n  /**\n   * Realiza o registro (Sign Up) com credenciais.\n   */\n  async signUp(\n    credentials: SignUpWithPasswordCredentials\n  ): Promise<{ user: AuthUser; token: string } | null> {\n    const { data, error } = await this.client.auth.signUp(credentials);\n\n    if (error || !data.user || !data.session) {\n      // Nota: O Supabase pode retornar um usuário sem sessão se a confirmação de e-mail estiver ativa.\n      // Para esta implementação de adaptador, consideramos um sucesso apenas se uma sessão for retornada.\n      return null;\n    }\n\n    const { id, email } = data.user;\n    if (!email) {\n      return null;\n    }\n\n    return {\n      user: { id, email },\n      token: data.session.access_token,\n    };\n  }\n\n  /**\n   * Realiza o logout (Sign Out).\n   */\n  async signOut(token: string): Promise<void> {\n    // A interface IAuthAdapter exige o token, embora o cliente Supabase (não-admin)\n    // geralmente invalide a sessão armazenada localmente nele.\n    \n    // Para garantir que estamos invalidando o contexto correto, \n    // primeiro definimos a sessão no cliente usando o token fornecido.\n    const { error: setError } = await this.client.auth.setSession({\n      access_token: token,\n      refresh_token: '', // O refresh token não é necessário para o signOut\n    });\n\n    if (setError) {\n      console.error('SupabaseAuthAdapter: Error setting session before sign-out:', setError.message);\n      // Continua mesmo assim, para tentar o signOut\n    }\n\n    // Chama o signOut do cliente\n    const { error: signOutError } = await this.client.auth.signOut();\n\n    if (signOutError) {\n      console.error('SupabaseAuthAdapter: Error during sign-out:', signOutError.message);\n    }\n  }\n}\n"
  }
]